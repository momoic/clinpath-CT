---
title: "Untitled"
output: html_document
date: "2025-09-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(shapviz)
library(ggplot2)
library(caret)
library(survival)
library(survminer)
library(dplyr)
library(gtsummary)
library(data.table)
library(clusterGeneration)
library(devtools)
library(ClusterR)
library(nnet)
library(randomForest)
library(e1071)
library(xgboost)
library(mclust)
library(cluster)
library(kernlab)
library(mboost)
library(treeshap)
library(kernelshap)
library(doFuture)
library(forcats)
library(dbscan)
library(StatMatch)
library(kamila)
library(umap)
library(uwot)
library(philentropy)
library(stepmixr)
library(superml)
library(reticulate)
```

Need to fix the significance calculation for low risk, need to think how to represent no met + high breslow depth in chi2 signficance test 

```{r}
calc_sig <- function(data, index){
  risk_table = NULL
  for (i in 1:index){
    data$Comparison <- NA
    data$Comparison[data$Group != unique(data$Group)[i]] <- "NC"
    data$Comparison[data$Group == unique(data$Group)[i]] <- "C"
    if (length(unique(data$Comparison)) > 1){
    logrank <- survdiff(Surv(Met_Time, Mets) ~ Comparison, data = data)
    pval <- logrank$pvalue
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
      risk <- "HR"
    }
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- "LR"
    }
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- NA
    }
    if (!is.na(pval) & pval < 0.05){
        sig <- "S"
      }
    if (!is.na(pval) & pval >= 0.05){
        sig <- "NS"
      }
    row = data.frame("Risk" = risk, "Cluster" = unique(data$Group)[i], "Significance" = sig, "pval" = pval)
    risk_table = rbind(risk_table, row)
    }
  }

    lr_clusters = subset(risk_table, Risk == "LR")$Cluster
    #low_risk = subset(data, data$Group %in% lr_clusters)
    lr_sig = c()

    for (i in 1:length(lr_clusters)){
      data$Comparison <- NA
      data$Comparison[data$Group != lr_clusters[i]] <- "NC"
      data$Comparison[data$Group == lr_clusters[i]] <- "C"
      # data$breslow_class = NA
      # data$breslow_class[low_risk$Breslow_Depth >= 1] = "high"
      # data$breslow_class[low_risk$Breslow_Depth < 1] = "low"
      
      if (length(unique(data$Comparison)) > 1 & length(unique(data$Mets))>1){
      # logrank_pair <- pairwise_survdiff(Surv(Met_Time, Mets) ~ Comparison + breslow_class, data = data)
      # pval = logrank_pair$p.value[[2]]
      logrank = survdiff(Surv(Met_Time, Mets) ~ Comparison, data = subset(data, Breslow_Depth >=1))
      pval = logrank$pvalue
      if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
        side <- "low"
      }
      if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
        side <- "high"
      }
      if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
      risk <- NA
      }
      # if (length(logrank$obs) == 3){
      #     side <- "high" 
      #     }
      # if (length(logrank$obs) == 4){
      #     if (((logrank$obs[[1]])/nrow(subset(low_risk, Comparison == "C" & breslow_class == "high"))) > ((logrank$obs[[3]])/nrow(subset(low_risk, Comparison == "NC" & breslow_class == "high")))){
      #       side <- "high"
      #     }
      #     if (((logrank$obs[[1]])/nrow(subset(low_risk, Comparison == "C" & breslow_class == "high"))) < ((logrank$obs[[3]])/nrow(subset(low_risk, Comparison == "NC" & breslow_class == "high")))){
      #       side <- "low"
      #     }
      #     if (((logrank$obs[[1]]+logrank$obs[[2]])/nrow(subset(low_risk, Comparison == "C"))) == ((logrank$obs[[3]]+logrank$obs[[4]])/nrow(subset(low_risk, Comparison == "NC")))){
      #     side <- NA
      #     }
      #   }
      
      if (risk_table[risk_table$Cluster == lr_clusters[[i]], "pval"] < 0.05 & pval < 0.05){
        sig <- "S"
      }
      if (!is.na(pval) & pval >= 0.05){
      sig <- "NS"
      }
      row <- data.frame("Risk" = "LR", "Side" = side, "Significance" = sig, "Cluster" = lr_clusters[i], pval)
      }else{
        row = data.frame("Risk" = "LR", "Side" = NA, "Significance" = NA, "Cluster" = lr_clusters[i], pval = NA)
      }
      lr_sig = rbind(lr_sig, row)
      }
  
    high_risk = subset(data, data$Group %in% subset(risk_table, Risk == "HR")$Cluster)
    hr_clusters = subset(risk_table, Risk == "HR")$Cluster
    hr_sig = c()
    
    for (i in 1:length(hr_clusters)){
      data$Comparison <- NA
      data$Comparison[data$Group != hr_clusters[i]] <- "NC"
      data$Comparison[data$Group == hr_clusters[i]] <- "C"
      if (length(unique(data$Comparison)) > 1){
      logrank <- survdiff(Surv(Met_Time, Mets) ~ Comparison, data = data)
      pval <- logrank$pvalue
      if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
        side <- "high"
      }
      if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
      side <- "low"
      }
      if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
      risk <- NA
      }
      if (pval < 0.05){
        sig <- "S"
      }
      if (pval >= 0.05){
      sig <- "NS"
      }
      row <- data.frame("Risk" = "HR", "Side" = side, "Significance" = sig, "Cluster" = hr_clusters[i], pval)
      }
      else{
        row = data.frame("Risk" = "HR", "Side" = "NA", "Significance" = "NA", "Cluster" = hr_clusters[i], pval = "NA")
      }
      hr_sig = rbind(hr_sig, row)
      }
    return(rbind(lr_sig,hr_sig))
}

calc_sig_MSS <- function(data, index){
  risk_table = NULL
  for (i in 1:index){
    data$Comparison <- NA
    data$Comparison[data$Group != unique(data$Group)[i]] <- "NC"
    data$Comparison[data$Group == unique(data$Group)[i]] <- "C"
    if (length(unique(data$Comparison)) > 1){
    logrank <- survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = data)
    pval <- logrank$pvalue
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
      risk <- "HR"
    }
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- "LR"
    }
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- NA
    }
    if (!is.na(pval) & pval < 0.05){
        sig <- "S"
      }
    if (!is.na(pval) & pval >= 0.05){
        sig <- "NS"
      }
    row = data.frame("Risk" = risk, "Cluster" = unique(data$Group)[i], "Significance" = sig, "pval" = pval)
    risk_table = rbind(risk_table, row)
    }
  }

    lr_clusters = subset(risk_table, Risk == "LR")$Cluster
    low_risk = subset(data, data$Group %in% lr_clusters)
    lr_sig = c()

    for (i in 1:length(lr_clusters)){
      low_risk$Comparison <- NA
      low_risk$Comparison[low_risk$Group != lr_clusters[i]] <- "NC"
      low_risk$Comparison[low_risk$Group == lr_clusters[i]] <- "C"
      
      low_risk$high_feat = NA
      low_risk$high_feat[low_risk$Ulceration == 1 & low_risk$Breslow_Depth >= 1] = "high"
      low_risk$high_feat[low_risk$Ulceration == 0 & low_risk$Breslow_Depth < 1] = "low"
      

      if (length(unique(data$Comparison)) > 1 & length(unique(data$MSS))>1){
      logrank_pair <- pairwise_survdiff(Surv(MSS_Time, MSS) ~ Comparison + high_feat, data = low_risk)
      pval_c = logrank_pair$p.value[[1]]
      pval_nc = logrank_pair$p.value[[2]]
      
      logrank = survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = subset(low_risk, Breslow_Depth >=1))
      pval = logrank$pvalue
      logrank$n[[1]]
      if ((logrank$obs[[1]]/logrank$n[[1]]) < (logrank$obs[[2]]/logrank$n[[2]])){
        side <- "low"
      }
      if ((logrank$obs[[1]]/logrank$n[[1]]) > (logrank$obs[[2]]/logrank$n[[2]])){
        side <- "high"
      }

      if ((logrank$obs[[1]]/logrank$n[[1]]) == (logrank$obs[[2]]/logrank$n[[2]])){
      side <- NA
      }
      # if (length(logrank$obs) == 3){
      #     side <- "high"
      #     }
      # if (length(logrank$obs) == 4){
      #     if (((logrank$obs[[1]])/nrow(subset(low_risk, Comparison == "C" & breslow_class == "high"))) > ((logrank$obs[[3]])/nrow(subset(low_risk, Comparison == "NC" & breslow_class == "high")))){
      #       side <- "high"
      #     }
      #     if (((logrank$obs[[1]])/nrow(subset(low_risk, Comparison == "C" & breslow_class == "high"))) < ((logrank$obs[[3]])/nrow(subset(low_risk, Comparison == "NC" & breslow_class == "high")))){
      #       side <- "low"
      #     }
      #     if (((logrank$obs[[1]]+logrank$obs[[2]])/nrow(subset(low_risk, Comparison == "C"))) == ((logrank$obs[[3]]+logrank$obs[[4]])/nrow(subset(low_risk, Comparison == "NC")))){
      #     side <- NA
      #     }
      #   }
      
      ifelse(risk_table[risk_table$Cluster == lr_clusters[[i]], "pval"] < 0.05 & pval_c > 0.05 & pval_nc < 0.05, sig <- "S", sig <- "NS")
      
      row <- data.frame("Risk" = "LR", "Side" = side, "Significance" = sig, "Cluster" = lr_clusters[i], pval)
      }
      else{
        row = data.frame("Risk" = "LR", "Side" = NA, "Significance" = NA, "Cluster" = lr_clusters[i], pval = NA)
      }
      
      lr_sig = rbind(lr_sig, row)
      }


    high_risk = subset(data, data$Group %in% subset(risk_table, Risk == "HR")$Cluster)
    hr_clusters = subset(risk_table, Risk == "HR")$Cluster
    hr_sig = c()

    for (i in 1:length(hr_clusters)){
      high_risk$Comparison <- NA
      high_risk$Comparison[high_risk$Group != hr_clusters[i]] <- "NC"
      high_risk$Comparison[high_risk$Group == hr_clusters[i]] <- "C"
      if (length(unique(high_risk$Comparison)) > 1){
      logrank <- survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = high_risk)
      pval <- logrank$pvalue
      
      if ((logrank$obs[[1]]/logrank$n[[1]]) > (logrank$obs[[2]]/logrank$n[[2]])){
        side <- "high"
      }
      if ((logrank$obs[[1]]/logrank$n[[1]]) < (logrank$obs[[2]]/logrank$n[[2]])){
      side <- "low"
      }
      if ((logrank$obs[[1]]/logrank$n[[1]]) == (logrank$obs[[2]]/logrank$n[[2]])){
      risk <- NA
      }
      if (pval < 0.05){
        sig <- "S"
      }
      if (pval >= 0.05){
      sig <- "NS"
      }
      row <- data.frame("Risk" = "HR", "Side" = side, "Significance" = sig, "Cluster" = hr_clusters[i], pval)
      }else{
        row = data.frame("Risk" = "HR", "Side" = "NA", "Significance" = "NA", "Cluster" = hr_clusters[i], pval = "NA")
      }
      hr_sig = rbind(hr_sig, row)
      }
    return(rbind(lr_sig,hr_sig))
}

calc_sig_orig <- function(i, data){
  
  data$Comparison <- NA
  data$Comparison[data$Group != i] <- "NC"
  data$Comparison[data$Group == i] <- "C"
  if (length(unique(data$Comparison)) > 1){
  logrank <- survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = data)
  pval <- logrank$pvalue
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- "HR"
  }
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
  risk <- "LR"
  }
  if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
  risk <- NA
  }
  if (pval < 0.05){
    sig <- "S"
  }
  if (pval >= 0.05){
  sig <- "NS"
  }
  if (logrank$obs[[1]] == 0){
    z <- 1
  }
    if (logrank$obs[[1]] > 0){
    z <- 0
  }
  row <- data.frame("Risk" = risk, "Significance" = sig, "Cluster" = i, "Z" = z)
  return(row)
  }
}
```

```{r}
risk_sig <- function(i, data){
  data$Comparison <- NA
  data$Comparison[data$Group != i] <- "NC"
  data$Comparison[data$Group == i] <- "C"
  if (length(unique(data$Comparison)) > 1){
  logrank <- survdiff(Surv(Met_Time, Mets) ~ Comparison, data = data)
  pval <- logrank$pvalue
  
  if (pval < 0.05){
    sig <- "S"
  }
  if (pval >= 0.05){
  sig <- "NS"
  }
  row <- data.frame("Risk" = risk, "Significance" = sig, "Cluster" = i)
  return(row)
  }
}

risk_class_gmm = function(data, cluster_sig){
  data$Risk = 1

  high_risk = subset(data, data$Group %in% subset(cluster_sig, Risk == "HR" & Significance == "S" & Side == "high")$Cluster)
  low_risk = subset(data, data$Group %in% subset(cluster_sig, Risk == "LR" & Significance == "S" & Side == "low")$Cluster)
  low_risk_clusters = (low_risk %>%
      mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = ifelse(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, Mets, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(N, ratio = p[Mets == "Alive" & Breslow_Depth == "High"]/p[Mets == "Alive" & Breslow_Depth == "Low"]) %>%
      slice_max(ratio, n = 2) %>%
      slice_max(N, n = 2))$Group 

      #slice_max(ratio, n = 1))$Group

  high_risk_clusters = (high_risk %>%
    mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
    count(Group, Mets) %>%
    group_by(Group) %>%
    mutate(N = sum(n), p = 100*n/N) %>%
    filter(Mets == "Dead") %>%
    filter(p>25))$Group

  data$Risk[data$Group %in% high_risk_clusters] = 2
  data$Risk[data$Group %in% low_risk_clusters] = 0
  return(data)
}

risk_class_gmm_MSS = function(data, cluster_sig){
  data$Risk = 1

  high_risk = subset(data, data$Group %in% subset(cluster_sig, Risk == "HR" & Significance == "S" & Side == "high")$Cluster)
  low_risk = subset(data, data$Group %in% subset(cluster_sig, Risk == "LR" & Significance == "S" & Side == "low")$Cluster)
  low_risk_clusters = (low_risk %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = if_else(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, MSS, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(ratio = p[MSS == "Alive" & Breslow_Depth == "High"]/p[MSS == "Alive" & Breslow_Depth == "Low"]) %>%
      filter(ratio > 0.9))$Group
    #%>%
      # slice_max(ratio, n = 2) %>%
      # slice_max(N, n = 2))$Group 

      #slice_max(ratio, n = 1))$Group

  high_risk_clusters = (high_risk %>%
    mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
    count(Group, MSS) %>%
    group_by(Group) %>%
    mutate(N = sum(n), p = 100*n/N) %>%
    filter(MSS == "Dead") %>%
    filter(p>25))$Group

  data$Risk[data$Group %in% high_risk_clusters] = 2
  data$Risk[data$Group %in% low_risk_clusters] = 0
  return(data)
}
risk_class = function(data, cluster_sig){
  data$Risk = 1
  
  if (length(subset(cluster_sig, Risk == "HR")$Cluster) > 1){
   high_risk_clusters = subset(cluster_sig, Risk == "HR" & Significance == "S" & Side == "high")$Cluster
  }
  else{
    high_risk_clusters = subset(cluster_sig, Risk == "HR")$Cluster
  }
  
  if (length(subset(cluster_sig, Risk == "LR")$Cluster) > 1){
    low_risk_clusters = subset(cluster_sig, Risk == "LR" & Significance == "S" & Side == "low")$Cluster
  }
  else{
    low_risk_clusters = subset(cluster_sig, Risk == "LR")
  }
  
  data$Risk[data$Group %in% high_risk_clusters] = 2
  data$Risk[data$Group %in% low_risk_clusters] = 0
  return(data)
}

```

using GMM
```{r}
set.seed(1)
data = read.csv("C://PhD work//Melanoma-ClinPath-Model//Final Analysis - JAAD Submission//Datasets//SEER_final.csv")
#data = read.csv("C://PhD work//clinpath_CT//roswell_no_added.csv")
data = data[,-c(1,18)]
#data = data[,-c(14,17,18)]

#inTraining = createDataPartition(data.ml$Age, p = 0.1, list = FALSE)
#data = data[inTraining,] #take 1/10 of the data

preProcValues <- preProcess(data, method = c("center", "scale"))
data.ml = predict(preProcValues, data)

opt_gmm = Optimal_Clusters_GMM(data.ml, max_clusters = 50, criterion = "BIC",

                              dist_mode = "maha_dist", seed_mode = "random_subset",

                              km_iter = 100, em_iter = 100, var_floor = 1e-10,

                              plot_data = F)
plot(1:50, opt_gmm)


diff_list = c()
for (i in 1:(length(opt_gmm)-3)){
  gmm_diff = (opt_gmm[i+3] - opt_gmm[i])/opt_gmm[i]
  diff_list = c(diff_list, gmm_diff)
}

index = which(diff_list < 0.10)[[2]]
#index = 25
gmm = GMM(data.ml, index, dist_mode = "maha_dist", seed_mode = "random_subset", km_iter = 500,
          em_iter = 100, verbose = F)   
 

pr = predict(gmm, newdata = data.ml)

data$Group <- as.factor(pr)
data.ml$Group = as.factor(pr)

data2 <- calc_sig_MSS(data, index)
#data2 <- calc_sig(data, index)

high_risk = subset(data, data$Group %in% subset(data2, Risk == "HR" & Significance == "S" & Side == "high")$Cluster)

data %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      count(Group, MSS) %>%
      group_by(Group) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      filter(MSS == "Dead") %>%
      ggplot(aes(x = fct_reorder(Group, p, .desc = TRUE), y = p))+
      geom_col()

high_risk %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      count(Group, MSS)

hr_clusters = (high_risk %>%
    mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
    count(Group, MSS) %>%
    group_by(Group) %>%
    mutate(N = sum(n), p = 100*n/N) %>%
    filter(MSS == "Dead") %>%
    filter(p > 25))$Group
    
low_risk = subset(data, data$Group %in% subset(data2, Risk == "LR" & Significance == "S" & Side == "low")$Cluster)

low_risk %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = if_else(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, MSS, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(ratio = p[MSS == "Alive" & Breslow_Depth == "High"]/p[MSS == "Alive" & Breslow_Depth == "Low"]) %>%
      filter(ratio > 0.9)
      
      #%>%
      #slice_max(ratio, n = 2) %>%
      #slice_max(N, n = 2) 

lr_clusters = (low_risk %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = ifelse(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, MSS, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(ratio = p[MSS == "Alive" & Breslow_Depth == "High"]/p[MSS == "Alive" & Breslow_Depth == "Low"])%>%
      slice_max(ratio, n = 2))$Group

risk_data = risk_class(data, data2)
table(data$Group)
risk_gmm = risk_data$Risk
table(risk_data$Risk)

sum(risk_data$MSS)
sum(risk_data[risk_data$Risk == 2,]$MSS)
sum(risk_data[risk_data$Risk == 1,]$MSS)
sum(risk_data[risk_data$Risk == 0,]$MSS)

sum(low_risk$MSS)
```


```{r}
risk_table = NULL
  for (i in 1:index){
    data$Comparison <- NA
    data$Comparison[data$Group != unique(data$Group)[i]] <- "NC"
    data$Comparison[data$Group == unique(data$Group)[i]] <- "C"
    if (length(unique(data$Comparison)) > 1){
    logrank <- survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = data)
    pval <- logrank$pvalue
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
      risk <- "HR"
    }
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- "LR"
    }
    if ((logrank$obs[[1]]/nrow(subset(data, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(data, Comparison == "NC")))){
    risk <- NA
    }
    if (!is.na(pval) & pval < 0.05){
        sig <- "S"
      }
    if (!is.na(pval) & pval >= 0.05){
        sig <- "NS"
      }
    row = data.frame("Risk" = risk, "Cluster" = unique(data$Group)[i], "Significance" = sig, "pval" = pval)
    risk_table = rbind(risk_table, row)
    }
  }

    lr_clusters = subset(risk_table, Risk == "LR")$Cluster
    low_risk = subset(data, data$Group %in% lr_clusters)
    lr_sig = c()

    for (i in 1:length(lr_clusters)){
      low_risk$Comparison <- NA
      low_risk$Comparison[low_risk$Group != lr_clusters[i]] <- "NC"
      low_risk$Comparison[low_risk$Group == lr_clusters[i]] <- "C"
      
      low_risk$high_feat = NA
      low_risk$high_feat[low_risk$Ulceration == 1 & low_risk$Breslow_Depth >= 1] = "high"
      low_risk$high_feat[low_risk$Ulceration == 0 & low_risk$Breslow_Depth < 1] = "low"
      

      if (length(unique(data$Comparison)) > 1 & length(unique(data$MSS))>1){
      logrank_pair <- pairwise_survdiff(Surv(MSS_Time, MSS) ~ Comparison + high_feat, data = low_risk)
      pval_c = logrank_pair$p.value[[1]]
      pval_nc = logrank_pair$p.value[[2]]
      
      logrank = survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = subset(low_risk, Breslow_Depth >=1))
      pval = logrank$pvalue
      
      if ((logrank$obs[[1]]/nrow(subset(low_risk, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(low_risk, Comparison == "NC")))){
        side <- "low"
      }
      if ((logrank$obs[[1]]/nrow(subset(low_risk, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(low_risk, Comparison == "NC")))){
        side <- "high"
      }

      if ((logrank$obs[[1]]/nrow(subset(low_risk, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(low_risk, Comparison == "NC")))){
      side <- NA
      }
      # if (length(logrank$obs) == 3){
      #     side <- "high"
      #     }
      # if (length(logrank$obs) == 4){
      #     if (((logrank$obs[[1]])/nrow(subset(low_risk, Comparison == "C" & breslow_class == "high"))) > ((logrank$obs[[3]])/nrow(subset(low_risk, Comparison == "NC" & breslow_class == "high")))){
      #       side <- "high"
      #     }
      #     if (((logrank$obs[[1]])/nrow(subset(low_risk, Comparison == "C" & breslow_class == "high"))) < ((logrank$obs[[3]])/nrow(subset(low_risk, Comparison == "NC" & breslow_class == "high")))){
      #       side <- "low"
      #     }
      #     if (((logrank$obs[[1]]+logrank$obs[[2]])/nrow(subset(low_risk, Comparison == "C"))) == ((logrank$obs[[3]]+logrank$obs[[4]])/nrow(subset(low_risk, Comparison == "NC")))){
      #     side <- NA
      #     }
      #   }
      
      sig = ifelse(risk_table[risk_table$Cluster == lr_clusters[[i]], "pval"] < 0.05 & pval_c > 0.05 & pval_nc < 0.05, "S", "NS")
      
      row <- data.frame("Risk" = "LR", "Side" = side, "Significance" = sig, "Cluster" = lr_clusters[i], pval)
      }
      else{
        row = data.frame("Risk" = "LR", "Side" = NA, "Significance" = NA, "Cluster" = lr_clusters[i], pval = NA)
      }
      
      lr_sig = rbind(lr_sig, row)
      }


    high_risk = subset(data, data$Group %in% subset(risk_table, Risk == "HR")$Cluster)
    hr_clusters = subset(risk_table, Risk == "HR")$Cluster
    hr_sig = c()

    for (i in 1:length(hr_clusters)){
      high_risk$Comparison <- NA
      high_risk$Comparison[high_risk$Group != hr_clusters[i]] <- "NC"
      high_risk$Comparison[high_risk$Group == hr_clusters[i]] <- "C"
      if (length(unique(high_risk$Comparison)) > 1){
      logrank <- survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = high_risk)
      pval <- logrank$pvalue
      if ((logrank$obs[[1]]/nrow(subset(high_risk, Comparison == "C"))) > (logrank$obs[[2]]/nrow(subset(high_risk, Comparison == "NC")))){
        side <- "high"
      }
      if ((logrank$obs[[1]]/nrow(subset(high_risk, Comparison == "C"))) < (logrank$obs[[2]]/nrow(subset(high_risk, Comparison == "NC")))){
      side <- "low"
      }
      if ((logrank$obs[[1]]/nrow(subset(high_risk, Comparison == "C"))) == (logrank$obs[[2]]/nrow(subset(high_risk, Comparison == "NC")))){
      risk <- NA
      }
      if (pval < 0.05){
        sig <- "S"
      }
      if (pval >= 0.05){
      sig <- "NS"
      }
      row <- data.frame("Risk" = "HR", "Side" = side, "Significance" = sig, "Cluster" = hr_clusters[i], pval)
      }else{
        row = data.frame("Risk" = "HR", "Side" = "NA", "Significance" = "NA", "Cluster" = hr_clusters[i], pval = "NA")
      }
      hr_sig = rbind(hr_sig, row)
    }
rbind(lr_sig, hr_sig)

pvals = NULL
for (i in lr_clusters){
  low_risk$Comparison <- NA
  low_risk$Comparison[low_risk$Group != i] <- "NC"
  low_risk$Comparison[low_risk$Group == i] <- "C"
  logrank <- pairwise_survdiff(Surv(MSS_Time, MSS) ~ Comparison + high_feat, data = low_risk)
  #logrank <- survdiff(Surv(MSS_Time, MSS) ~ Comparison , data = subset(data, Breslow_Depth >=1))
  #logrank
  pvals = c(list(logrank$p.value), pvals)

  
}
pvals
pvals[[3]]
pvals[[3]][[1]] > 0.05
pvals[[3]][[2]] < 0.05

low_risk$Comparison <- NA
low_risk$Comparison[low_risk$Group != 2] <- "NC"
low_risk$Comparison[low_risk$Group == 2] <- "C"

logrank = survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = subset(low_risk, Breslow_Depth >= 1 & Ulceration == 1))
logrank = survdiff(Surv(MSS_Time, MSS) ~ Comparison, data = subset(low_risk, Breslow_Depth >= 1 & Ulceration == 1))
logrank$obs[1]/logrank$n[[1]]
logrank$obs[2]/logrank$n[[2]]

```


using HDBSCAN, might need to shelf this because dimensional reduction is not going to work well for us if we want to predict what features are gonna be useful
```{r}
set.seed(1)
#data = read.csv("C://PhD work//Melanoma-ClinPath-Model//Final Analysis - JAAD Submission//Datasets//SEER_final.csv")
data = read.csv("C://PhD work//clinpath_CT//roswell_no_added.csv")

data = data[,-c(14,17,18)]
#inTraining = createDataPartition(data.ml$Age, p = 0.1, list = FALSE)
#data = data[inTraining,] #take 1/10 of the data

factor_col = c()

for (i in 1:ncol(data)){
  if (length(unique(data[,i])) == 2){
    factor_col = c(factor_col, colnames(data)[[i]])
  }
}


# data[factor_col] = lapply(data[factor_col], as.numeric)
data.cat = data[factor_col]
data.con = data[,!(colnames(data) %in% factor_col)]
# dice = distance(data.cat, method = "dice")
preProcValues = preProcess(data.con, method = c("center", "scale"))
data.con.ml = predict(preProcValues, data.con)

data.ml = cbind(data.con.ml, data.cat)

umap = umap(data.ml, metric= list(
  "euclidean" = colnames(data.con),
  "categorical" = colnames(data.cat)
), init = "random", n_neighbors = 30, n_components = 2, min_dist = 0.5, spread = 3, learning_rate = 1, n_epochs = 2000, nn_method = "annoy")

plot(umap)
# umap_con = umap(data.con.ml, n_neighbors = 30, min_dist = 0.01, n_components = 10)
# umap_cat = umap(data_cat, n_neighbors = 150, min_dist = 0.01, n_components = 10)

hdb = hdbscan(umap, minPts = 40)
plot(hdb, show_flat = T)
table(hdb$cluster)

data$Group = as.factor(hdb$cluster)

data2 <- calc_sig(data, length(unique(hdb$cluster)))
 

data %>%
      mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
      count(Group, Mets) %>%
      group_by(Group) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      filter(Mets == "Dead") %>%
      ggplot(aes(x = fct_reorder(Group, p, .desc = TRUE), y = p))+
      geom_col()

data %>%
      mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = ifelse(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, Mets, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(ratio = p[Mets == "Alive" & Breslow_Depth == "High"]/p[Mets == "Alive" & Breslow_Depth == "Low"])


data = risk_class(data, data2)
risk_hdb = data$Risk
adjustedRandIndex(risk_hdb, risk_gmm)
table(data$Risk)

```

using KAMILA clustering algorithm - extension of k means and GMM to categorical and continuous data
```{r}
set.seed(1)
#data = read.csv("C://PhD work//Melanoma-ClinPath-Model//Final Analysis - JAAD Submission//Datasets//SEER_final.csv")
data = read.csv("C://PhD work//clinpath_CT//roswell_no_added.csv")

data = data[,-c(14,17,18)]
#inTraining = createDataPartition(data.ml$Age, p = 0.1, list = FALSE)
#data = data[inTraining,] #take 1/10 of the data

factor_col = c()
for (i in 1:ncol(data)){
  if (length(unique(data[,i])) == 2){
    factor_col = c(factor_col, colnames(data)[[i]])
  }
} 

cat_data = as.data.frame(lapply(data[factor_col], as.factor))

con_data = data[!(colnames(data) %in% factor_col)]
preProcValues <- preProcess(con_data, method = c("center", "scale"))
con_data.ml = predict(preProcValues, con_data)
data.ml = cbind(con_data.ml, cat_data)

kam_res = kamila(conVar = con_data.ml, catFactor = cat_data, numClust = 6, numInit = 200, maxIter = 20, catBw = 0.05)

pr = kam_res$finalMemb

data$Group <- as.factor(pr)
data.ml$Group = as.factor(pr)

data2 <- data.table::rbindlist(lapply(1:index, calc_sig, data))

high_risk = subset(data, data$Group %in% subset(data2, Risk == "HR")$Cluster)

data %>%
      mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
      count(Group, Mets) %>%
      group_by(Group) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      filter(Mets == "Dead") %>%
      ggplot(aes(x = fct_reorder(Group, p, .desc = TRUE), y = p))+
      geom_col()

hr_clusters = (high_risk %>%
    mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
    count(Group, Mets) %>%
    group_by(Group) %>%
    mutate(N = sum(n), p = 100*n/N) %>%
    filter(Mets == "Dead") %>%
    filter(p > 25))$Group
    
low_risk = subset(data, data$Group %in% subset(data2, Risk == "LR")$Cluster)

lr_clusters = (low_risk %>%
      mutate(Mets = if_else(Mets == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = ifelse(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, Mets, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(ratio = p[Mets == "Alive" & Breslow_Depth == "High"]/p[Mets == "Alive" & Breslow_Depth == "Low"])%>%
      slice_max(ratio, n = 2))$Group

data = risk_class(data, data2)

adjustedRandIndex(data$Risk, risk_gmm)
adjustedRandIndex(data$Risk, risk_hdb)
table(data$Risk)
```

stepmix
```{r}
set.seed(1)
data = read.csv("C://PhD work//Melanoma-ClinPath-Model//Final Analysis - JAAD Submission//Datasets//SEER_final.csv")
data = data[,-c(1,18)]

#data = read.csv("C://PhD work//clinpath_CT//roswell_no_added.csv")
#data = data[,-c(14,17,18)]
#inTraining = createDataPartition(data.ml$Age, p = 0.1, list = FALSE)
#data = data[inTraining,] #take 1/10 of the data

factor_col = c()
for (i in 1:ncol(data)){
  if (length(unique(data[,i])) == 2){
    factor_col = c(factor_col, colnames(data)[[i]])
  }
} 

#py_install("stepmix", pip = TRUE)

mixed_data = mixed_descriptor(data = data, continuous = colnames(data[!(colnames(data) %in% factor_col)]), binary = factor_col)


model = stepmix(n_components = 4, measurement = mixed_data$descriptor, random_state = "42", verbose = F, max_iter = 1000)
data = mixed_data$data
mixed_fit = fit(model,data)

data$Group = as.factor(predict(mixed_fit, X = data))
table(data$Group)


data2 <- calc_sig_MSS(data, model$n_components)
 

data %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      count(Group, MSS) %>%
      group_by(Group) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      filter(MSS == "Dead") %>%
      ggplot(aes(x = fct_reorder(Group, p, .desc = TRUE), y = p))+
      geom_col()

data %>%
      mutate(MSS = if_else(MSS == 1, "Dead", "Alive")) %>%
      mutate(Breslow_Depth = if_else(Breslow_Depth > 1, "High", "Low")) %>%
      count(Group, MSS, Breslow_Depth) %>%
      group_by(Group, Breslow_Depth) %>%
      mutate(N = sum(n), p = 100*n/N) %>%
      group_by(Group) %>%
      reframe(ratio = p[MSS == "Alive" & Breslow_Depth == "High"]/p[MSS == "Alive" & Breslow_Depth == "Low"])


risk_data = risk_class(data, data2)
table(risk_data$Risk)

sum(risk_data$MSS)
sum(risk_data[risk_data$Risk == 2,]$MSS)
sum(risk_data[risk_data$Risk == 1,]$MSS)
sum(risk_data[risk_data$Risk == 0,]$MSS)

risk_stepmix = data$Risk
adjustedRandIndex(risk_stepmix, risk_gmm)

```

